# Техническая документация Apple-Unlocker

## Оглавление
1. [Обзор проекта](#обзор-проекта)
2. [Архитектура системы](#архитектура-системы)
3. [Основные компоненты](#основные-компоненты)
4. [API и методы](#api-и-методы)
5. [Конфигурация](#конфигурация)
6. [Обработка ошибок](#обработка-ошибок)
7. [Безопасность](#безопасность)
8. [Зависимости](#зависимости)
9. [Логирование](#логирование)
10. [Развертывание](#развертывание)

---

## Обзор проекта

**Apple-Unlocker** - это автоматизированный инструмент для разблокировки аккаунтов Apple ID через процедуру сброса пароля. Система использует официальные API Apple для восстановления доступа к заблокированным аккаунтам.

### Основные возможности:
- Автоматическое решение капчи через сервис YesCaptcha
- Верификация данных аккаунта (дата рождения, секретные вопросы)
- Сброс пароля с установкой нового
- Многопоточная обработка множественных аккаунтов
- Интеграция с VPN (ExpressVPN) для обхода ограничений
- Расширенное логирование и обработка ошибок

---

## Архитектура системы

### Схема работы:
```
[Accounts.txt] → [unlocker.py] → [Apple API] → [Success.txt/error.txt]
                      ↓
                [YesCaptcha API] ← [Captcha Solving]
                      ↓
                [ExpressVPN API] ← [VPN Management]
```

### Основной поток выполнения:
1. **Инициализация** - загрузка настроек и создание сессии
2. **Получение SSTT токена** - аутентификация с Apple
3. **Решение капчи** - через YesCaptcha API
4. **Верификация Apple ID** - отправка email для проверки
5. **Выбор метода восстановления** - секретные вопросы
6. **Верификация даты рождения** - подтверждение личности
7. **Ответы на секретные вопросы** - финальная верификация
8. **Сброс пароля** - установка нового пароля

---

## Основные компоненты

### 1. Класс `unlocker`

**Файл:** `unlocker.py`  
**Основной класс:** `unlocker()`

#### Методы класса:

##### `__init__(self) -> None`
Конструктор класса, инициализирует пустой объект.

##### `unlock(self, data_email: str) -> None`
Основной метод для разблокировки аккаунта.

**Параметры:**
- `data_email` (str): Строка с данными аккаунта в формате CSV

**Процесс выполнения:**
1. Парсинг данных аккаунта
2. Создание TLS сессии
3. Получение SSTT токена
4. Решение капчи
5. Верификация данных
6. Сброс пароля

### 2. Вспомогательные функции

##### `remove_line_containing_text(file_path: str, target_text: str) -> None`
Удаляет строки из файла, содержащие указанный текст.

**Параметры:**
- `file_path` (str): Путь к файлу
- `target_text` (str): Текст для поиска и удаления

**Использование:** Удаление обработанных аккаунтов из `Accounts.txt`

---

## API и методы

### Apple API Endpoints

#### 1. Получение SSTT токена
```
GET https://iforgot.apple.com/password/verify/appleid
```
**Назначение:** Получение токена сессии для аутентификации  
**Возвращает:** HTML страницу с встроенным SSTT токеном

#### 2. Получение капчи
```
GET https://iforgot.apple.com/captcha?captchaType=IMAGE
```
**Параметры:** 
- `captchaType=IMAGE` - тип капчи

**Возвращает:**
```json
{
    "token": "captcha_token",
    "payload": {
        "content": "base64_image_data"
    },
    "id": "captcha_id"
}
```

#### 3. Верификация Apple ID
```
POST https://iforgot.apple.com/password/verify/appleid
```
**Тело запроса:**
```json
{
    "id": "user@example.com",
    "captcha": {
        "id": "captcha_id",
        "answer": "captcha_solution",
        "token": "captcha_token"
    }
}
```

#### 4. Выбор метода аутентификации
```
POST https://iforgot.apple.com/password/verify/method
```
**Тело запроса:**
```json
{
    "type": "questions"
}
```

#### 5. Верификация даты рождения
```
POST https://iforgot.apple.com/password/verify/birthday
```
**Тело запроса:**
```json
{
    "monthOfYear": "MM",
    "dayOfMonth": "DD",
    "year": "YYYY"
}
```

#### 6. Получение секретных вопросов
```
GET https://iforgot.apple.com/password/verify/questions
```
**Возвращает:**
```json
{
    "questions": [
        {
            "question": "Вопрос 1",
            "number": 1,
            "id": "question_id_1"
        },
        {
            "question": "Вопрос 2", 
            "number": 2,
            "id": "question_id_2"
        }
    ]
}
```

#### 7. Отправка ответов на вопросы
```
POST https://iforgot.apple.com/password/verify/questions
```
**Тело запроса:**
```json
{
    "questions": [
        {
            "question": "Вопрос 1",
            "answer": "Ответ 1",
            "id": "question_id_1",
            "number": 1
        },
        {
            "question": "Вопрос 2",
            "answer": "Ответ 2", 
            "id": "question_id_2",
            "number": 2
        }
    ]
}
```

#### 8. Сброс пароля
```
POST https://iforgot.apple.com/password/reset
```
**Тело запроса:**
```json
{
    "password": "new_password"
}
```

### YesCaptcha API

#### Инициализация клиента
```python
from yescaptcha.client import Client
from yescaptcha.task import ImageToTextTask

client = Client(client_key="API_KEY")
```

#### Решение капчи
```python
task = ImageToTextTask(base64_image)
job = client.create_task(task)
solution = job.get_solution_text()
```

### ExpressVPN API

#### Подключение к VPN
```python
from evpn import ExpressVpnApi

with ExpressVpnApi() as api:
    api.connect(server_id)
```

**Доступные серверы:** `[84,3,166,19,1,202,2,165,18,172,161,9,95,3,74,3,70,204,94,71,207,79,45,169,178,15,90,5,153,8,103,150,182,29]`

---

## Конфигурация

### 1. Файл настроек `files/settings.json`

```json
{
    "API_KEY": "your_yescaptcha_api_key",
    "new_password": "new_password_to_set",
    "vpn_enabled": false
}
```

**Параметры:**
- `API_KEY` (string): API ключ для YesCaptcha
- `new_password` (string): Новый пароль для установки
- `vpn_enabled` (boolean): Включение/отключение VPN

### 2. Файл аккаунтов `files/Accounts.txt`

**Формат строки:**
```
email,password,answer1,answer2,answer3,MM/DD/YY
```

**Пример:**
```
user@example.com,oldpassword,bestfriend,teacher,moscow,01/15/90
```

**Индексы ответов:**
- Индекс 2: Ответ на первый секретный вопрос
- Индекс 3: Ответ на второй секретный вопрос  
- Индекс 4: Ответ на третий секретный вопрос
- Индекс 5: Дата рождения в формате MM/DD/YY

### 3. Маппинг секретных вопросов

```python
qus = {
    # Китайские версии
    "你少年时代最好的朋友叫什么名字": 2,
    "你的理想工作是什么": 3,
    "你的父母是在哪里认识的": 4,
    
    # Английские версии
    "the name of a childhood friend": 2,
    "What is the name of a childhood friend?": 2,
    "dream job": 3,
    "What is your dream job?": 3,
    "where the parents met": 4,
    "Where did your parents meet?": 4,
    
    # Дополнительные вопросы
    "What was your first pet's name?": 5,
    "What was the name of your first school?": 6,
    "What city were you born in?": 7
}
```

---

## Обработка ошибок

### Типы ошибок и их обработка:

#### 1. Ошибки капчи
```python
if 'captchaAnswer.Invalid' in response.text:
    # Повторная попытка решения капчи
    continue
```

#### 2. Ошибки лимитов (503)
```python
if response.status_code == 503:
    if settings.get('vpn_enabled', True):
        # Смена VPN сервера
        api.connect(random_server)
    time.sleep(10)
```

#### 3. Ошибки превышения попыток (410)
```python
if response.status_code == 410:
    # Слишком много попыток - аккаунт заблокирован
    remove_line_containing_text('files/Accounts.txt', data_email)
    log_error("Too many attempts")
```

#### 4. Ошибки секретных вопросов
```python
if response.status_code == 400:
    # Неверные ответы на секретные вопросы
    error_response = response.json()
    if 'serviceErrors' in error_response:
        for error in error_response['serviceErrors']:
            if error.get('code') == 'crIncorrect':
                log_error("Security answers incorrect")
```

#### 5. Ошибки отсутствующих данных
```python
try:
    questions = response.json()['questions']
except KeyError:
    log_error("No questions in response")
    return
```

### Коды состояния HTTP:

| Код | Значение | Действие |
|-----|----------|----------|
| 200 | Успех | Продолжить выполнение |
| 302 | Перенаправление | Следовать по Location заголовку |
| 400 | Неверные данные | Логировать ошибку, пропустить аккаунт |
| 410 | Слишком много попыток | Удалить аккаунт из очереди |
| 503 | Сервис недоступен | Сменить VPN, повторить |

---

## Безопасность

### 1. Заголовки запросов

```python
headers = {
    "accept-language": "en-US,en;q=0.9,ar;q=0.8",
    "cache-control": "no-cache",
    "content-type": "application/json",
    "pragma": "no-cache",
    "sec-ch-ua": "\"Google Chrome\";v=\"131\", \"Chromium\";v=\"131\", \"Not_A Brand\";v=\"24\"",
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": "\"Windows\"",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors", 
    "sec-fetch-site": "same-origin",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
    "sstt": "session_token",
    "x-requested-with": "XMLHttpRequests",
    "x-apple-i-fd-client-info": "{\"U\":\"Mozilla/5.0...\",\"L\":\"en-US\",\"Z\":\"GMT+02:00\",\"V\":\"1.1\",\"F\":\"...\"}"
}
```

### 2. TLS конфигурация

```python
session = tls_client.Session(
    random_tls_extension_order=True,
    client_identifier="chrome_128"
)
```

### 3. Управление токенами

**SSTT токен:** Извлекается из HTML ответа и используется для аутентификации:
```python
sstt = urllib.parse.quote(
    response.text.split('"sstt":"')[1].split('","captchaEnabled":true,')[0]
)
```

**Обновление токенов:** Токены обновляются на каждом этапе процесса:
```python
if 'Sstt' in response.headers:
    headers['sstt'] = response.headers['Sstt']
```

---

## Зависимости

### Основные библиотеки:

#### 1. `tls_client`
**Назначение:** HTTP клиент с поддержкой TLS fingerprinting  
**Использование:** Создание сессий, имитирующих браузер Chrome

#### 2. `yescaptcha`
**Назначение:** Решение капчи через API сервис  
**Компоненты:**
- `Client` - основной клиент API
- `ImageToTextTask` - задача распознавания текста с изображения
- `Job` - управление задачами решения капчи

#### 3. `evpn` (ExpressVPN)
**Назначение:** Управление VPN подключениями  
**Использование:** Смена IP адреса при блокировках

#### 4. `colorama`
**Назначение:** Цветной вывод в консоль  
**Использование:** Форматирование сообщений об ошибках и успехах

#### 5. `concurrent.futures`
**Назначение:** Многопоточная обработка  
**Использование:** Параллельная обработка множественных аккаунтов

### Полный список зависимостей (`requirements.txt`):
```
tls_client
requests  
colorama
evpn
loguru
typing_extensions
```

---

## Логирование

### Конфигурация логирования:

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('files/debug.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
```

### Уровни логирования:

#### INFO
- Успешные операции
- Получение токенов
- Прогресс выполнения

#### WARNING  
- Отсутствующие заголовки (не критично)
- Использование fallback значений

#### ERROR
- Критические ошибки
- Отсутствующие обязательные данные
- Неверные ответы API

#### DEBUG
- Детальная информация о запросах
- Содержимое ответов
- Отладочная информация

### Примеры логирования:

```python
logger.info(f"[{email}] Got Sstt token from birthday GET")
logger.warning(f"[{email}] No Sstt header in birthday POST response")
logger.error(f"[{email}] Questions validation failed (400)")
logger.debug(f"[{email}] Full payload: {payload}")
```

### Файлы логов:

- `files/debug.log` - детальные логи выполнения
- `files/Success.txt` - успешно обработанные аккаунты
- `files/error.txt` - аккаунты с ошибками

---

## Развертывание

### Системные требования:

- **Python:** 3.7+
- **ОС:** Windows, macOS, Linux
- **Память:** Минимум 512MB RAM
- **Интернет:** Стабильное подключение

### Установка:

#### 1. Клонирование репозитория:
```bash
git clone https://github.com/Levcqhh/Apple-Unlocker.git
cd Apple-Unlocker
```

#### 2. Создание виртуального окружения:
```bash
python -m venv apple-unlocker-env
source apple-unlocker-env/bin/activate  # Linux/macOS
# или
apple-unlocker-env\Scripts\activate     # Windows
```

#### 3. Установка зависимостей:
```bash
pip install -r requirements.txt
```

#### 4. Настройка конфигурации:
```bash
# Создать files/settings.json
{
    "API_KEY": "your_yescaptcha_api_key",
    "new_password": "your_new_password",
    "vpn_enabled": false
}

# Создать files/Accounts.txt
email1,password1,answer1,answer2,answer3,01/15/90
email2,password2,answer1,answer2,answer3,02/20/85
```

### Запуск:

#### Основной режим:
```bash
python unlocker.py
```

#### С логированием:
```bash
python unlocker.py > output.log 2>&1
```

#### В фоновом режиме:
```bash
nohup python unlocker.py &
```

### Мониторинг:

#### Просмотр логов в реальном времени:
```bash
tail -f files/debug.log
```

#### Проверка прогресса:
```bash
wc -l files/Accounts.txt    # Оставшиеся аккаунты
wc -l files/Success.txt     # Успешные
wc -l files/error.txt       # Ошибки
```

### Производительность:

- **Многопоточность:** 1 поток по умолчанию (настраивается)
- **Скорость:** ~1-2 аккаунта в минуту
- **Ограничения:** Зависят от лимитов Apple API и YesCaptcha

### Рекомендации по безопасности:

1. **Не используйте на продакшн серверах**
2. **Используйте VPN для обхода блокировок**
3. **Регулярно обновляйте User-Agent строки**
4. **Мониторьте логи на предмет блокировок**
5. **Используйте разные API ключи для YesCaptcha**

---

## Заключение

Apple-Unlocker представляет собой комплексное решение для автоматизированного восстановления доступа к аккаунтам Apple ID. Система использует официальные API Apple в сочетании с внешними сервисами для решения капчи и управления VPN подключениями.

**Ключевые особенности:**
- Полная автоматизация процесса восстановления
- Расширенная обработка ошибок и логирование
- Поддержка множественных языков секретных вопросов
- Интеграция с внешними сервисами (YesCaptcha, ExpressVPN)
- Многопоточная обработка для повышения производительности

**Важные замечания:**
- Используйте инструмент ответственно и в соответствии с условиями использования Apple
- Регулярно обновляйте конфигурацию для поддержания совместимости
- Мониторьте логи для выявления и устранения проблем

Для получения дополнительной поддержки обращайтесь к документации отдельных компонентов или к сообществу разработчиков.
